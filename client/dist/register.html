<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Image Key Register</title>
    <style>
      body {
        align-items: center;
      }
      nav {
        display: flex;
        align-content: center;
        justify-content: center;
        height: 6rem;
        width: 50%;
        padding: 0 6rem;
        z-index: 100;
        margin: auto;
        font-size: 1.7rem;
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <a class="homepage"> Image Key</a>
      </nav>
    </header>
    <h1>Select and Upload your Key Image here</h1>
    <br />
    <h3>
      Key Image is the image that you use for login, it can be image of
      anything.
    </h3>
    <br />
    <iframe
      name="prevent--redirect"
      id="prevent--redirect"
      style="display: none"
    ></iframe>
    <form
      target="prevent--redirect"
      action="/registerimage"
      enctype="multipart/form-data"
      method="post"
      class="key-image"
    >
      <input type="file" name="r--image--key" accept="image/*" />
      <input type="submit" class="submit--btn" />
    </form>
    <br />
    <h1>
      After finished processing your image, we will take a picture of you to
      verify.
    </h1>
    <br class="br" />
    <script src="src/js/controller.js"></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"
    ></script>
    <script>
      function takeFacePic() {
        const br = document.querySelector(".br");
        br.insertAdjacentHTML(
          "afterend",
          `<div class="face">
            <video id="webcam" autoplay playsinline width="640" height="480"></video>
            <canvas id="canvas" class="d-none"></canvas>
            <button class="facePic">Take picture when you ready</button>
          </div>`
        );
        const webcamElement = document.getElementById("webcam");
        const canvasElement = document.getElementById("canvas");
        const faceBtn = document.querySelector(".facePic");
        const webcam = new Webcam(webcamElement, "user", canvasElement, null);
        webcam.start();
        faceBtn.addEventListener("click", (e) => {
          e.preventDefault();
          const face = webcam.snap();
          webcam.stop();
          webcamElement.remove();
          faceBtn.remove();
          const formdata = new FormData();
          formdata.append("registerface", face);
          fetch("/registerface", {
            method: "POST",
            body: formdata,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data) {
                alert("Register Success");
                window.location.assign("/user");
              } else {
                canvasElement.remove();
                alert(
                  "We are not able to detect your face from the picture you just took.\nPlease take another picture"
                );
                takeFacePic();
              }
            });
        });
      }
      const form = document.querySelector(".key-image");
      form.addEventListener("submit", (e) => {
        let regID;
        fetch("/registerimage", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        })
          .then((res) => res.json())
          .then((data) => {
            regID = data;
            if (regID) {
              takeFacePic();
            } else {
              alert("This image is invalid, please submit another image");
            }
          });
      });
    </script>
  </body>
</html>
